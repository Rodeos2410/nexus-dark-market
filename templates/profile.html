{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="profile">
    <div class="profile-grid">
        <section class="card">
            <div class="profile-header">
                <div class="avatar">üë§</div>
                <div class="profile-meta">
                    <h2 class="profile-title">{{ current_user.username }}</h2>
                    <div class="muted">{{ current_user.email }}</div>
                    <div class="muted">–ù–∞ —Å–∞–π—Ç–µ —Å {{ current_user.created_at.strftime('%d.%m.%Y') }}</div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="stat">
                    <div class="stat-value">{{ current_user.products|length }}</div>
                    <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="user-balance">{{ "%.2f"|format(current_user.balance) }}‚ÇΩ</div>
                    <div class="stat-label">–ë–∞–ª–∞–Ω—Å</div>
                </div>
            </div>
        </section>

        <section class="card">
            <h3>Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            
            {% if current_user.telegram_chat_id %}
                <div style="background: #4caf50; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    ‚úÖ <b>Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!</b><br>
                    <small>–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–¥–∞–∂–∞—Ö –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤</small>
                </div>
                
                <!-- –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div style="background: #1a1a1a; padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #444;">
                    <strong>üß™ –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</strong><br>
                    <button onclick="testTelegram()" class="button" style="background:#4caf50; margin-top: 8px;">–¢–µ—Å—Ç Telegram</button>
                    <div class="hint muted" style="margin-top: 8px;">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤–∞—à Telegram
                    </div>
                </div>
            {% else %}
                <div style="background: #ff9800; color: #000; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    ‚ö†Ô∏è <b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</b><br>
                    <small>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö</small>
                </div>
                
                <!-- –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ -->
                <div style="background: #1a1a1a; padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #444;">
                    <strong>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</strong><br>
                    <div class="inline-form" style="margin-top: 8px;">
                        <input id="manual-chat-id" type="text" placeholder="–í–∞—à Telegram Chat ID" style="flex: 1;">
                        <button onclick="manualSetup()" class="button" style="background:#2196F3;">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                    </div>
                    <div class="hint muted" style="margin-top: 8px;">
                        <a href="https://t.me/NexusDarkBot?start=get_id" target="_blank" style="color: #2196F3; text-decoration: none;">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</a> —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID
                    </div>
                </div>
            {% endif %}
        </section>

        <section class="card">
            <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
            <div class="inline-form">
                <input id="deposit-amount" type="number" min="1" step="1" placeholder="–°—É–º–º–∞, ‚ÇΩ">
                <button onclick="deposit()" class="button" style="background:#4CAF50;">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
            <div class="hint muted">–ú–∏–Ω–∏–º—É–º 1‚ÇΩ. –ú–∞–∫—Å–∏–º—É–º 10000‚ÇΩ –∑–∞ —Ä–∞–∑.</div>
            <div class="divider"></div>
            <button onclick="showCryptoModal()" class="button">–û–ø–ª–∞—Ç–∏—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π</button>
        </section>

        <section class="card danger">
            <h3>–°–µ—Å—Å–∏—è</h3>
            <a href="{{ url_for('logout') }}" class="button" style="background:#d32f2f;">–í—ã–π—Ç–∏</a>
        </section>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫—Ä–∏–ø—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π -->
<div id="crypto-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000;">
    <div class="auth-center">
        <div class="auth-card">
            <div class="product-card">
                <h3>–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π</h3>
                <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –Ω–∞ –∞–¥—Ä–µ—Å:</p>
                <p><strong>USDT (TRC20):</strong></p>
                <p style="word-break: break-all; background: #0b0b0d; padding: 10px; border-radius: 8px; font-family: monospace;">TQ2r8...–≤–∞—à_–∞–¥—Ä–µ—Å</p>
                <button onclick="hideCryptoModal()" class="button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>


function manualSetup() {
    const chatId = document.getElementById('manual-chat-id').value.trim();
    
    if (!chatId) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram Chat ID', 'error');
        return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    fetch('/telegram/manual-setup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: chatId
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification(d.message || '–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 'error');
        }
    })
    .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}

function testTelegram() {
    showNotification('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...', 'info');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    fetch('/telegram/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.', 'success');
        } else {
            showNotification(d.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞', 'error');
        }
    })
    .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}
</script>
{% endblock %}