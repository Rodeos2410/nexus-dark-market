{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="auth-center">
    <div class="auth-card" style="width: 100%; max-width: 1200px;">
        <div class="product-card">
            <h2>üîß –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h2>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div style="color: green; text-align: center; margin: 10px;">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div style="background: #1a1a1f; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: #0b0b0d; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">{{ users|length }}</div>
                        <div style="color: #666;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div style="background: #0b0b0d; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196F3;">{{ users|selectattr('is_admin')|list|length }}</div>
                        <div style="color: #666;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
                    </div>
                    <div style="background: #0b0b0d; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f44336;">{{ users|selectattr('is_banned')|list|length }}</div>
                        <div style="color: #666;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
                    </div>
                    <div style="background: #0b0b0d; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #FF9800;">{{ users|rejectattr('is_banned')|list|length }}</div>
                        <div style="color: #666;">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>
            
            <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: #1a1a1f; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: #0b0b0d;">
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">ID</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">Email</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">–ë–∞–ª–∞–Ω—Å</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">Telegram</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 1px solid #333;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr style="border-bottom: 1px solid #333;">
                            <td style="padding: 12px;">{{ user.id }}</td>
                            <td style="padding: 12px;">
                                <div style="font-weight: bold;">{{ user.username }}</div>
                                {% if user.telegram_username %}
                                    <div style="font-size: 12px; color: #666;">@{{ user.telegram_username }}</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">{{ user.email }}</td>
                            <td style="padding: 12px;">{{ "%.2f"|format(user.balance) }}‚ÇΩ</td>
                            <td style="padding: 12px;">
                                {% if user.telegram_username %}
                                    <div style="font-size: 12px;">@{{ user.telegram_username }}</div>
                                    {% if user.telegram_chat_id %}
                                        <div style="font-size: 10px; color: #4CAF50;">‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω</div>
                                    {% else %}
                                        <div style="font-size: 10px; color: #FF9800;">‚ö†Ô∏è –ù—É–∂–µ–Ω /start</div>
                                    {% endif %}
                                {% else %}
                                    <div style="font-size: 12px; color: #666;">–ù–µ —É–∫–∞–∑–∞–Ω</div>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                {% if user.is_admin %}
                                    <span style="background: #9C27B0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">–ê–¥–º–∏–Ω</span>
                                {% endif %}
                                {% if user.is_banned %}
                                    <span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                                {% else %}
                                    <span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">{{ user.created_at.strftime('%d.%m.%Y') }}</td>
                            <td style="padding: 12px;">
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    {% if user.id != current_user.id %}
                                        {% if user.is_banned %}
                                            <button onclick="unbanUser({{ user.id }})" class="button" style="background: #4CAF50; font-size: 12px; padding: 4px 8px;">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                        {% else %}
                                            <button onclick="banUser({{ user.id }})" class="button" style="background: #f44336; font-size: 12px; padding: 4px 8px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                        {% endif %}
                                        
                                        {% if not user.is_admin %}
                                            <button onclick="makeAdmin({{ user.id }})" class="button" style="background: #9C27B0; font-size: 12px; padding: 4px 8px;">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
                                        {% else %}
                                            <button onclick="removeAdmin({{ user.id }})" class="button" style="background: #FF9800; font-size: 12px; padding: 4px 8px;">–£–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∞</button>
                                        {% endif %}
                                        
                                        {% if user.telegram_username and not user.telegram_chat_id and user.username != 'admin' %}
                                            <button onclick="setupTelegram({{ user.id }})" class="button" style="background: #2196F3; font-size: 12px; padding: 4px 8px;">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram</button>
                                        {% endif %}
                                        
                                        <button onclick="deleteUser({{ user.id }})" class="button" style="background: #d32f2f; font-size: 12px; padding: 4px 8px;">–£–¥–∞–ª–∏—Ç—å</button>
                                    {% else %}
                                        <span style="color: #666; font-size: 12px;">–í—ã</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    if (type === 'success') {
        notification.style.background = '#4caf50';
    } else if (type === 'error') {
        notification.style.background = '#f44336';
    } else {
        notification.style.background = '#2196f3';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

function banUser(userId) {
    if (!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
    
    fetch(`/admin/user/${userId}/ban`, { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(d.message, 'error');
            }
        })
        .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}

function unbanUser(userId) {
    if (!confirm('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
    
    fetch(`/admin/user/${userId}/unban`, { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(d.message, 'error');
            }
        })
        .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}

function makeAdmin(userId) {
    if (!confirm('–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?')) return;
    
    fetch(`/admin/user/${userId}/make_admin`, { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(d.message, 'error');
            }
        })
        .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}

function removeAdmin(userId) {
    if (!confirm('–£–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
    
    fetch(`/admin/user/${userId}/remove_admin`, { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(d.message, 'error');
            }
        })
        .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}

function setupTelegram(userId) {
    const chatId = prompt('–í–≤–µ–¥–∏—Ç–µ Telegram chat_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è chat_id:\n1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –±–æ—Ç—É @NexusDarkBot\n2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à chat_id –∏–∑ –∞–¥–º–∏–Ω–∫–∏ –±–æ—Ç–∞');
    if (!chatId) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ chat_id —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (!/^\d+$/.test(chatId)) {
        showNotification('Chat ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã!', 'error');
        return;
    }
    
    fetch(`/admin/user/${userId}/setup_telegram`, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId })
    })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(d.message, 'error');
            }
        })
        .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}

function deleteUser(userId) {
    if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç:\n- –ê–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n- –í—Å–µ –µ–≥–æ —Ç–æ–≤–∞—Ä—ã\n- –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    
    fetch(`/admin/user/${userId}/delete`, { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(d.message, 'error');
            }
        })
        .catch(() => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'));
}
</script>
{% endblock %}
