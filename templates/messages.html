{% extends "base.html" %}

{% block title %}–ú–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="auth-center">
    <div class="auth-card" style="width: 100%; max-width: 800px;">
        <div class="product-card">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333;">
                <a href="{{ url_for('market') }}" style="color: #4CAF50; text-decoration: none; font-size: 1.2em;">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
                <h1 style="margin: 0; color: #4CAF50;">üì¨ –ú–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è</h1>
            </div>
            
            {% if dialogues %}
                <div class="dialogues-list">
                    {% for user_id, dialogue in dialogues.items() %}
                    <div class="dialogue-item" style="background: #1a1a1f; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; cursor: pointer;" onclick="openChat({{ dialogue.last_message.product_id }})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: #4CAF50; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                                    {{ dialogue.user.username[0].upper() }}
                                </div>
                                <div>
                                    <h3 style="margin: 0; color: #4CAF50;">{{ dialogue.user.username }}</h3>
                                    <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                        {% if dialogue.last_message.product %}
                                            –¢–æ–≤–∞—Ä: {{ dialogue.last_message.product.name }}
                                        {% else %}
                                            –û–±—â–∏–π —á–∞—Ç
                                        {% endif %}
                                    </p>
                                    <p style="margin: 0; color: #ccc; font-size: 0.9em;">
                                        {% if dialogue.last_message.sender_id == current_user.id %}
                                            –í—ã: {{ dialogue.last_message.content[:50] }}{% if dialogue.last_message.content|length > 50 %}...{% endif %}
                                        {% else %}
                                            {{ dialogue.user.username }}: {{ dialogue.last_message.content[:50] }}{% if dialogue.last_message.content|length > 50 %}...{% endif %}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #666; font-size: 0.8em; margin-bottom: 5px;">
                                    {{ dialogue.last_message.created_at.strftime('%d.%m.%Y %H:%M') }}
                                </div>
                                {% if dialogue.unread_count > 0 %}
                                    <div style="background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; margin-left: auto;">
                                        {{ dialogue.unread_count }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; color: #666; padding: 40px;">
                    <h3>üì≠ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤ —Å –ø—Ä–æ–¥–∞–≤—Ü–∞–º–∏</p>
                    <a href="{{ url_for('market') }}" class="button" style="margin-top: 20px;">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function openChat(productId) {
    window.location.href = `/chat/${productId}`;
}
</script>
{% endblock %}
