{% extends "base.html" %}

{% block title %}–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å{% endblock %}

{% block content %}
<h1 class="rainbow-text">Nexus Dark</h1>

<div class="container">
    <div class="products-grid">
        {% for product in products %}
        <div class="product-card">
            {% if product.image %}
                <img src="{{ url_for('static', filename='uploads/' + product.image) }}" alt="{{ product.name }}">
            {% else %}
                <div style="height: 140px; background: #1a1a1f; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">
                    –ë–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </div>
            {% endif %}
            
            <h3>{{ product.name }}</h3>
            <p>{{ product.description }}</p>
            <div class="price">{{ product.price }}‚ÇΩ</div>
            <div class="muted">–û—Å—Ç–∞—Ç–æ–∫: {{ product.stock }}</div>
            
            <div class="product-actions">
                {% if current_user.is_authenticated %}
                    {% if product.seller_id != current_user.id %}
                        <div class="product-buttons" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                            <button onclick="addToCart({{ product.id }})" class="button cart-button" {% if product.stock is not none and product.stock <= 0 %}disabled style="opacity:.6; cursor:not-allowed;"{% endif %}>üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
                            <a href="{{ url_for('chat_with_seller', product_id=product.id) }}" class="button chat-button" style="background: #2196F3; text-decoration: none; display: flex; align-items: center; gap: 5px;">
                                üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
                            </a>
                        </div>
                    {% else %}
                        <span class="button" style="background:#333; cursor:default;">–í–∞—à —Ç–æ–≤–∞—Ä</span>
                    {% endif %}
                {% else %}
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <a class="button" href="{{ url_for('login') }}">–í–æ–π—Ç–∏, —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å</a>
                        <a class="button" href="{{ url_for('register') }}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                {% endif %}
                <span>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ product.seller.username }}</span>
            </div>
        </div>
        {% endfor %}
        
        {% if not products %}
        <div style="grid-column: 1 / -1; text-align: center; color: #666; padding: 40px;">
            <h3>–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <p>–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –¥–æ–±–∞–≤–∏—Ç —Ç–æ–≤–∞—Ä!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª—è–µ–º JavaScript –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script>
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    if (type === 'success') {
        notification.style.background = '#4caf50';
    } else if (type === 'error') {
        notification.style.background = '#f44336';
    } else {
        notification.style.background = '#2196f3';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

function addToCart(productId) {
    fetch(`/cart/add/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã –∏ —Å—á—ë—Ç—á–∏–∫
            if (typeof refreshCart === 'function') {
                refreshCart().then(() => {
                    const panel = document.getElementById('cart-panel');
                    if (panel && panel.classList.contains('cart-panel--hidden')) {
                        toggleCart();
                    }
                });
            }
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
    });
}
</script>
{% endblock %}