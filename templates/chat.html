{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º - {{ product.name }}{% endblock %}

{% block content %}
<div class="auth-center">
    <div class="auth-card" style="width: 100%; max-width: 800px;">
        <div class="product-card">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333;">
                <a href="{{ url_for('market') }}" style="color: #4CAF50; text-decoration: none; font-size: 1.2em;">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
                <div>
                    <h1 style="margin: 0; color: #4CAF50;">üí¨ –ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</h1>
                    <p style="margin: 5px 0 0 0; color: #666;">–¢–æ–≤–∞—Ä: <strong>{{ product.name }}</strong></p>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
            <div style="background: #1a1a1f; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    {% if product.image %}
                        <img src="{{ url_for('static', filename='uploads/' + product.image) }}" alt="{{ product.name }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                    {% else %}
                        <div style="width: 60px; height: 60px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px;">
                            –ù–µ—Ç —Ñ–æ—Ç–æ
                        </div>
                    {% endif %}
                    <div>
                        <h3 style="margin: 0; color: #4CAF50;">{{ product.name }}</h3>
                        <p style="margin: 5px 0; color: #666;">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
                        <div style="color: #4CAF50; font-weight: bold;">{{ product.price }}‚ÇΩ</div>
                    </div>
                </div>
            </div>
            
            <!-- –ß–∞—Ç -->
            <div id="chat-container" class="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #0a0a0a;">
                <div id="messages-container">
                    {% for message in messages %}
                    <div class="message {% if message.sender_id == current_user.id %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}" style="margin-bottom: 15px; animation: fadeIn 0.3s ease-in;">
                        <div style="display: flex; {% if message.sender_id == current_user.id %}justify-content: flex-end{% else %}justify-content: flex-start{% endif %};">
                            <div style="max-width: 70%; padding: 10px 15px; border-radius: 15px; word-wrap: break-word; {% if message.sender_id == current_user.id %}background: #4CAF50; color: white;{% else %}background: #333; color: #fff;{% endif %}">
                                <div style="font-size: 0.9em; margin-bottom: 5px; opacity: 0.8;">
                                    {% if message.sender_id == current_user.id %}
                                        –í—ã
                                    {% else %}
                                        {{ message.sender.username }}
                                    {% endif %}
                                    <span style="margin-left: 10px; font-size: 0.8em;">{{ message.created_at.strftime('%H:%M') }}</span>
                                    {% if message.sender_id == current_user.id %}
                                        <span class="message-status" style="margin-left: 5px; font-size: 0.7em;">
                                            {% if message.is_read %}
                                                ‚úÖ
                                            {% else %}
                                                ‚úì
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                                <div>{{ message.content }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not messages %}
                    <div id="empty-chat" style="text-align: center; color: #666; padding: 40px;">
                        <p>üí¨ –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</p>
                        <p style="font-size: 0.9em;">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–æ–≤–∞—Ä–µ –∏–ª–∏ –æ–±—Å—É–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –ø–æ–∫—É–ø–∫–∏</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
                <div id="typing-indicator" class="typing-indicator" style="display: none; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: flex-start;">
                        <div style="max-width: 70%; padding: 10px 15px; border-radius: 15px; background: #333; color: #fff;">
                            <div style="font-size: 0.9em; margin-bottom: 5px; opacity: 0.8;">
                                {{ product.seller.username }} –ø–µ—á–∞—Ç–∞–µ—Ç...
                            </div>
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <div id="loading-indicator" class="loading-indicator" style="display: none; text-align: center; padding: 10px; color: #666;">
                    <div class="loading-spinner"></div>
                    <span>–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...</span>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <form id="message-form" class="message-form" style="display: flex; gap: 10px;">
                <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #1a1a1f; color: white; font-size: 14px;" required>
                <button type="submit" style="padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </form>
            
            <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="{{ url_for('my_messages') }}" style="color: #4CAF50; text-decoration: none;">üì¨ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è</a>
            </div>
        </div>
    </div>
</div>

<script>
class LiveChat {
    constructor() {
        this.chatContainer = document.getElementById('chat-container');
        this.messagesContainer = document.getElementById('messages-container');
        this.messageForm = document.getElementById('message-form');
        this.messageInput = document.getElementById('message-input');
        this.typingIndicator = document.getElementById('typing-indicator');
        this.loadingIndicator = document.getElementById('loading-indicator');
        this.emptyChat = document.getElementById('empty-chat');
        
        this.productId = {{ product.id }};
        this.sellerId = {{ product.seller_id }};
        this.sellerName = '{{ product.seller.username }}';
        this.currentUserId = {{ current_user.id }};
        
        this.lastMessageId = this.getLastMessageId();
        this.isTyping = false;
        this.typingTimeout = null;
        this.pollInterval = null;
        this.isUserAtBottom = true;
        
        this.init();
    }
    
    init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∂–∏–≤–æ–≥–æ —á–∞—Ç–∞');
        console.log('üì¶ –¢–æ–≤–∞—Ä ID:', this.productId);
        console.log('üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü ID:', this.sellerId);
        console.log('üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü:', this.sellerName);
        console.log('üìù –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ID:', this.lastMessageId);
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        this.scrollToBottom();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.messageForm.addEventListener('submit', (e) => this.handleSubmit(e));
        this.messageInput.addEventListener('input', () => this.handleTyping());
        this.messageInput.addEventListener('keypress', (e) => this.handleKeyPress(e));
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        this.chatContainer.addEventListener('scroll', () => this.handleScroll());
        
        // –ó–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        this.startPolling();
        
        // –û—Ç–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        this.markMessagesAsRead();
        
        console.log('‚úÖ –ñ–∏–≤–æ–π —á–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
    
    getLastMessageId() {
        const messages = this.messagesContainer.querySelectorAll('.message[data-message-id]');
        if (messages.length === 0) return 0;
        const lastMessage = messages[messages.length - 1];
        return parseInt(lastMessage.dataset.messageId) || 0;
    }
    
    startPolling() {
        // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        this.pollInterval = setInterval(() => {
            this.checkForNewMessages();
        }, 2000);
        
        console.log('üîÑ –ó–∞–ø—É—â–µ–Ω –æ–ø—Ä–æ—Å –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π');
    }
    
    async checkForNewMessages() {
        try {
            const response = await fetch(`/get_new_messages/${this.productId}?last_id=${this.lastMessageId}`);
            const data = await response.json();
            
            if (data.success && data.messages.length > 0) {
                console.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ ${data.messages.length} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                data.messages.forEach(message => {
                    this.addMessageToChat(message, false);
                    this.lastMessageId = Math.max(this.lastMessageId, message.id);
                });
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É
                if (this.isUserAtBottom) {
                    this.scrollToBottom();
                }
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                this.playNotificationSound();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'info');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    }
    
    async handleSubmit(e) {
        e.preventDefault();
        
        const content = this.messageInput.value.trim();
        if (!content) return;
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        this.messageInput.value = '';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        this.showNotification('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ...', 'info');
        
        try {
            const response = await fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    receiver_id: this.sellerId,
                    product_id: this.productId,
                    content: content
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                const message = {
                    id: data.message_id,
                    content: content,
                    sender_id: this.currentUserId,
                    created_at: data.created_at,
                    is_read: false
                };
                
                this.addMessageToChat(message, true);
                this.lastMessageId = Math.max(this.lastMessageId, message.id);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –ø–µ—á–∞—Ç–∏
                this.sendTypingSignal(false);
                
            } else {
                this.showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                this.messageInput.value = content;
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            this.messageInput.value = content;
        }
    }
    
    handleTyping() {
        if (!this.isTyping) {
            this.isTyping = true;
            this.sendTypingSignal(true);
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–µ—á–∞—Ç–∏
        clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => {
            this.isTyping = false;
            this.sendTypingSignal(false);
        }, 1000);
    }
    
    handleKeyPress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.messageForm.dispatchEvent(new Event('submit'));
        }
    }
    
    async sendTypingSignal(isTyping) {
        try {
            await fetch('/typing_signal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: this.productId,
                    is_typing: isTyping
                })
            });
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –ø–µ—á–∞—Ç–∏:', error);
        }
    }
    
    async markMessagesAsRead() {
        try {
            await fetch('/mark_messages_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_id: this.productId,
                    sender_id: this.sellerId
                })
            });
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
        }
    }
    
    addMessageToChat(message, isSent) {
        // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç–æ–π —á–∞—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
        if (this.emptyChat) {
            this.emptyChat.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
        messageDiv.dataset.messageId = message.id;
        messageDiv.style.marginBottom = '15px';
        messageDiv.style.animation = 'fadeIn 0.3s ease-in';
        
        const timeString = new Date(message.created_at).toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const statusIcon = isSent ? (message.is_read ? '‚úÖ' : '‚úì') : '';
        
        messageDiv.innerHTML = `
            <div style="display: flex; ${isSent ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                <div style="max-width: 70%; padding: 10px 15px; border-radius: 15px; word-wrap: break-word; ${isSent ? 'background: #4CAF50; color: white;' : 'background: #333; color: #fff;'}">
                    <div style="font-size: 0.9em; margin-bottom: 5px; opacity: 0.8;">
                        ${isSent ? '–í—ã' : this.sellerName}
                        <span style="margin-left: 10px; font-size: 0.8em;">${timeString}</span>
                        ${statusIcon ? `<span style="margin-left: 5px; font-size: 0.7em;">${statusIcon}</span>` : ''}
                    </div>
                    <div>${this.escapeHtml(message.content)}</div>
                </div>
            </div>
        `;
        
        this.messagesContainer.appendChild(messageDiv);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É
        if (this.isUserAtBottom) {
            this.scrollToBottom();
        }
    }
    
    handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = this.chatContainer;
        this.isUserAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
    }
    
    scrollToBottom() {
        this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    }
    
    playNotificationSound() {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        
        if (type === 'success') {
            notification.style.background = '#4caf50';
        } else if (type === 'error') {
            notification.style.background = '#f44336';
        } else {
            notification.style.background = '#2196f3';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.style.transform = 'translateX(0)', 100);
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    destroy() {
        if (this.pollInterval) {
            clearInterval(this.pollInterval);
        }
        if (this.typingTimeout) {
            clearTimeout(this.typingTimeout);
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∂–∏–≤–æ–≥–æ —á–∞—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    window.liveChat = new LiveChat();
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
        if (window.liveChat) {
            window.liveChat.destroy();
        }
    });
});
</script>
{% endblock %}
